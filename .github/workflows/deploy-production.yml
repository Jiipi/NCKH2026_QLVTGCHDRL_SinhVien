name: Deploy to EC2 Production

# ===================================================================
# CI/CD WORKFLOW - Auto deploy khi push to main branch
# Deploy stack: PostgreSQL + Backend + Frontend + Nginx
# Target: AWS EC2 (hoatdongrenluyen.io.vn)
# ===================================================================

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Cho phÃ©p trigger manual

env:
  IMAGE_TAG: ${{ github.sha }}
  DOCKER_COMPOSE_FILE: docker-compose.production.yml

jobs:
  # ==================== JOB 1: Build vÃ  Test ====================
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      # - name: Run backend tests
      #   working-directory: ./backend
      #   run: npm test

      # - name: Run frontend tests
      #   working-directory: ./frontend
      #   run: npm test -- --passWithNoTests

      - name: Build frontend
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://hoatdongrenluyen.io.vn/api
        run: npm run build

      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: |
            frontend/build
            backend/node_modules
          key: ${{ runner.os }}-build-${{ github.sha }}

  # ==================== JOB 2: Deploy to EC2 ====================
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file on server
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/hoatdongrenluyen
            
            # Backup old .env if exists
            if [ -f .env ]; then
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # Create new .env from secrets
            cat > .env << 'ENVFILE'
          NODE_ENV=production
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          PORT=3001
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=7d
          JWT_REFRESH_EXPIRES_IN=30d
          CORS_ORIGIN=https://hoatdongrenluyen.io.vn,https://www.hoatdongrenluyen.io.vn
          REACT_APP_API_URL=https://hoatdongrenluyen.io.vn/api
          MAX_FILE_SIZE=10485760
          LOG_LEVEL=info
          IMAGE_TAG=${{ github.sha }}
          ENVFILE
          EOF

      - name: Deploy application
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/hoatdongrenluyen
            
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ”¨ Building Docker images..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} build --no-cache
            
            echo "ðŸ—‘ï¸ Stopping old containers..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} down
            
            echo "ðŸš€ Starting new containers..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} up -d
            
            echo "â³ Waiting for services to be healthy..."
            sleep 30
            
            echo "ðŸ” Checking container status..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} ps
            
            echo "âœ… Deployment completed!"
          EOF

      - name: Run database migrations
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/hoatdongrenluyen
            echo "ðŸ”„ Running database migrations..."
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} exec -T backend npx prisma db push --accept-data-loss || true
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} exec -T backend npx prisma generate || true
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/hoatdongrenluyen
            
            echo "ðŸ¥ Health check..."
            
            # Check backend health
            BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health || echo "000")
            echo "Backend status: $BACKEND_STATUS"
            
            # Check frontend health
            FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:80/health || echo "000")
            echo "Frontend status: $FRONTEND_STATUS"
            
            # Check all containers are running
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} ps | grep -i "up"
            
            if [ "$BACKEND_STATUS" != "200" ]; then
              echo "âŒ Backend health check failed!"
              docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} logs backend --tail 50
              exit 1
            fi
            
            echo "âœ… All services are healthy!"
          EOF

      - name: Cleanup old Docker images
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -af --filter "until=72h" || true
            docker system prune -f || true
          EOF

      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment SUCCESS for commit ${{ github.sha }}"
          else
            echo "âŒ Deployment FAILED for commit ${{ github.sha }}"
          fi

  # ==================== JOB 3: Rollback (Manual trigger only) ====================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Rollback to previous version
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/hoatdongrenluyen
            
            echo "âª Rolling back to previous version..."
            
            # Get previous commit
            git log --oneline -2
            PREV_COMMIT=$(git log --format="%H" -n 2 | tail -1)
            
            echo "Rolling back to commit: $PREV_COMMIT"
            git checkout $PREV_COMMIT
            
            # Restore .env backup
            if [ -f .env.backup.* ]; then
              LATEST_BACKUP=$(ls -t .env.backup.* | head -1)
              cp $LATEST_BACKUP .env
            fi
            
            # Rebuild and restart
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} down
            docker compose -f ${{ env.DOCKER_COMPOSE_FILE }} up -d --build
            
            echo "âœ… Rollback completed!"
          EOF
